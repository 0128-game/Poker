<!-- ⚠️ 次の完全リニューアル版 HTMLコードに置き換えました（CPU手札は裏面表示・ボタンは手順に応じて表示変更・交換アニメ表現・カードデザイン強化） -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Draw Poker</title>
<style>
    body {
        font-family: "Segoe UI", sans-serif;
        background: #004400;
        color: #fff;
        text-align: center;
        margin: 0;
        padding: 0;
    }
    #table {
        width: 100vw;
        height: 80vh;
        position: relative;
        margin: auto;
    }
    .player, .cpu {
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .cards {
        display: flex;
        gap: 6px;
        margin-top: 8px;
    }
    .card {
        width: 70px;
        height: 100px;
        border-radius: 8px;
        background: white;
        border: 2px solid #222;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: bold;
        color: black;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .back {
        background: repeating-linear-gradient(45deg, #004, #004 5px, #00a 5px, #00a 10px);
        border: 2px solid #88f;
        color: transparent;
        cursor: default;
    }
    .selected {
        outline: 4px solid yellow;
        transform: translateY(-10px);
    }
    button {
        padding: 10px 24px;
        font-size: 20px;
        margin-top: 10px;
        border-radius: 8px;
        cursor: pointer;
    }
    #status {
        margin-top: 12px;
        font-size: 22px;
        font-weight: bold;
        min-height: 32px;
    }
    #chipInput, #betInput {
        font-size: 24px;
        margin-top: 6px;
        width: 200px;
    }
</style>
</head>
<body>
<h1>Draw Poker（CPU戦）</h1>
<div id="status"></div>
<div id="table"></div>
<div id="controls"></div>
<script>
// ======= 変数 =======
let players = [];
let dealerIndex = 0;
let deck = [];
let phase = "init";
let selectedCards = [];
let pot = 0;

const table = document.getElementById("table");
const status = document.getElementById("status");
const controls = document.getElementById("controls");

// ======= デッキ生成 =======
function makeDeck() {
    const suits = ["♠","♥","♦","♣"];
    const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    deck = [];
    for (let s of suits) for (let r of ranks) deck.push({s, r});
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

// ======= プレイヤー配置 =======
function createTable(cpuCount, chips) {
    players = [];
    players.push({name: "YOU", chips, hand: [], folded: false, isCPU: false});
    for (let i = 0; i < cpuCount; i++)
        players.push({name: "CPU" + (i + 1), chips, hand: [], folded: false, isCPU: true});
    placePlayers();
    phase = "dealer";
    nextPhase();
}

function placePlayers() {
    table.innerHTML = "";
    const total = players.length;
    const cx = table.clientWidth / 2;
    const cy = table.clientHeight / 2;
    const rx = table.clientWidth * 0.43;
    const ry = table.clientHeight * 0.34;
    players.forEach((p, i) => {
        const angle = (i / total) * 2 * Math.PI - Math.PI / 2;
        const x = cx + rx * Math.cos(angle);
        const y = cy + ry * Math.sin(angle);
        const div = document.createElement("div");
        div.className = p.isCPU ? "cpu" : "player";
        div.style.left = x + "px";
        div.style.top = y + "px";
        div.id = "pl" + i;
        const label = document.createElement("div");
        label.textContent = `${p.name}（${p.chips}）`;
        const cards = document.createElement("div");
        cards.className = "cards";
        div.appendChild(label);
        div.appendChild(cards);
        table.appendChild(div);
    });
}

// ======= UI更新 =======
function render() {
    players.forEach((p, i) => {
        const div = document.getElementById("pl" + i);
        div.children[0].textContent = `${p.name}（${p.chips}）`;
        const cardsDiv = div.children[1];
        cardsDiv.innerHTML = "";
        if (p.hand.length === 0) return;
        p.hand.forEach((c, idx) => {
            const card = document.createElement("div");
            card.className = "card";
            if (p.isCPU) {
                card.classList.add("back");
            } else {
                card.textContent = c.r + c.s;
                card.addEventListener("click", () => toggleSelect(i, idx));
                if (selectedCards.includes(idx)) card.classList.add("selected");
            }
            cardsDiv.appendChild(card);
        });
    });
}

function toggleSelect(pid, cid) {
    if (players[pid].isCPU) return;
    if (!selectedCards.includes(cid)) selectedCards.push(cid);
    else selectedCards = selectedCards.filter(v => v !== cid);
    render();
}

// ======= フェーズ管理 =======
function nextPhase() {
    controls.innerHTML = "";

    if (phase === "dealer") {
        dealerIndex = Math.floor(Math.random() * players.length);
        status.textContent = `ディーラー: ${players[dealerIndex].name}`;
        createButton("ブラインド支払い", () => {phase = "deal"; nextPhase();});
        return;
    }
    if (phase === "deal") {
        makeDeck();
        pot = 0;
        selectedCards = [];
        players.forEach(p => {p.hand = []; p.folded = false;});
        for (let i = 0; i < 5; i++) for (let p of players) p.hand.push(deck.pop());
        status.textContent = "配布完了 — 第1ベット";
        render();
        phase = "bet1";
    }
    if (phase === "bet1") return betting();
    if (phase === "draw") return drawPhase();
    if (phase === "bet2") return betting();
    if (phase === "showdown") return showdown();
}

// ======= ベット =======
function betting() {
    status.textContent = (phase === "bet1") ? "第1ベット" : "第2ベット";
    createButton("コール/チェック", endBetting);
    createButton("レイズ", () => {
        controls.innerHTML = "<input id='betInput' type='number' min='1' /><br>";
        createButton("決定", () => {
            const val = parseInt(document.getElementById("betInput").value||"0");
            pot += val;
            players[0].chips -= val;
            endBetting();
        });
    });
    createButton("ドロップ", () => {players[0].folded = true; endBetting();});
}

function endBetting() {
    controls.innerHTML = "";
    if (phase === "bet1") { phase = "draw"; nextPhase(); }
    else { phase = "showdown"; nextPhase(); }
}

// ======= 交換 =======
function drawPhase() {
    status.textContent = "交換 — 捨てたいカードを選んでください";
    createButton("交換", () => {
        const p = players[0];
        let newHand = [];
        p.hand.forEach((c, i) => {
            if (!selectedCards.includes(i)) newHand.push(c);
        });
        while (newHand.length < 5) newHand.push(deck.pop());
        p.hand = newHand;
        selectedCards = [];
        players.forEach(cpu => {
            if (cpu.isCPU) {
                const keep = Math.floor(Math.random() * 5);
                cpu.hand = cpu.hand.slice(0, keep);
                while (cpu.hand.length < 5) cpu.hand.push(deck.pop());
            }
        });
        render();
        phase = "bet2";
        nextPhase();
    });
}

// ======= 判定（非常に簡易） =======
function rankValue(card) {
    return ["A","2","3","4","5","6","7","8","9","10","J","Q","K"].indexOf(card.r);
}

function handStrength(hand) {
    return hand.map(rankValue).reduce((a,b)=>a+b,0);
}

function showdown() {
    status.textContent = "ショーダウン";
    controls.innerHTML = "";
    render();
    let best = -1, winner = 0;
    players.forEach((p,i)=>{
        if (!p.folded) {
            const v = handStrength(p.hand);
            if (v > best) { best = v; winner = i; }
        }
    });
    players[winner].chips += pot;
    status.textContent = `${players[winner].name} の勝ち！（+${pot}）`;
    createButton("コンティニュー", () => {phase="deal"; nextPhase();});
    render();
}

// ======= ボタン生成 =======
function createButton(text, fn){
    const b = document.createElement("button");
    b.textContent = text;
    b.onclick = fn;
    controls.appendChild(b);
}

// ======= 開始画面 =======
status.textContent = "CPU数と初期チップを選択";
controls.innerHTML = `<input id='cpuCount' type='number' min='1' max='8' value='4' /> CPU<br>
<input id='chipInput' type='number' value='1000' /><br>`;
createButton("開始", () => {
    const n = parseInt(document.getElementById("cpuCount").value||"3");
    const c = parseInt(document.getElementById("chipInput").value||"1000");
    createTable(n, c);
});
</script>
</body>
</html>
